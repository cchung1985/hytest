<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Project name</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<!-- Bootstrap -->
		<link href="css/bootstrap.css" rel="stylesheet" media="screen">
		<!--
		<link href="less/bootstrap.less" rel="stylesheet/less">
		-->
		<style>
		body {
			padding-top: 40px; /* 60px to make the container go all the way to the bottom of the topbar */
		}
		#map_canvas {
			position: absolute;
			top: 40px;
			left: 0px;
			right: 0px;
			bottom: 0px;
			z-index: -1;
		}
		#loginModal {
		}
		
		#settingModal {
			*min-height:500px;
		}
		
		#sellerPanel {
			*min-height:500px;
		}
		
		.list {
			list-style: none outside none;
			margin: 0;
		}
		
		</style>
		<link href="css/bootstrap-responsive.css" rel="stylesheet">
		<style>
		
		.modal {
			outline: none;
			position: absolute;
			margin-top: 0;
			top: 50%;
			overflow: visible; /* allow content to popup out (i.e tooltips) */
		}
		
		.modal.fade {
			top: -100%;
			-webkit-transition: opacity 0.3s linear, top 0.3s ease-out, bottom 0.3s ease-out, margin-top 0.3s ease-out;	
			   -moz-transition: opacity 0.3s linear, top 0.3s ease-out, bottom 0.3s ease-out, margin-top 0.3s ease-out;
			     -o-transition: opacity 0.3s linear, top 0.3s ease-out, bottom 0.3s ease-out, margin-top 0.3s ease-out;
			        transition: opacity 0.3s linear, top 0.3s ease-out, bottom 0.3s ease-out, margin-top 0.3s ease-out;
		}
		
		
		.modal-body {
			max-height: none;
			overflow: visible;
		}
		
		.modal.container {
			width: 940px;
			margin-left: -470px;
		}
		
		/* Large desktop */
		@media (min-width: 1200px) {
			.modal.container {
				width: 1170px;
				margin-left: -585px;
			}
		}
		 
		/* Portrait tablet to landscape and desktop */
		@media (min-width: 768px) and (max-width: 979px) {
			.modal.container {
				width: 728px;
				margin-left: -362px;
			}
		}
		 
		/* Landscape phone to portrait tablet */
		@media (max-width: 767px) {
			.modal, 
			.modal.container {
				top: 1%;
				right: 1%;
				left: 1%;
				bottom: auto;
				width: auto !important;
				height: auto !important;
				margin: 0 !important;
				padding: 0 !important;
			}
		</style>
		<!--
		<link href="css/bootstrap-modal.css" rel="stylesheet">
		<link href="less/responsive.less" rel="stylesheet/less">
		-->
	<script type="text/javascript"
		src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDVe-jIXFr-OWQknSaDsjLyogR6Lm9goB8&sensor=false">
	</script>
	</head>
	<body>
		<div id="navBar" class="navbar navbar-inverse navbar-fixed-top">
			<div class="navbar-inner">
				<div class="container">
					<button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a class="brand" href="#">Project name</a>
					<form class="navbar-search">
						<input type="text" class="search-query" placeholder="搜尋">
					</form>

					<div class="nav-collapse collapse">
						<ul id="guestNav" class="nav pull-right">
							<li><a class="btn-loginModal" href="#loginModal" data-toggle="modal">登入</a></li>
							<li><a class="btn-regModal" href="#regModal" data-toggle="modal">註冊</a></li>
						</ul>
						<ul id="userNav" class="nav pull-right">
							<li><a class="btn-myCart" href="#" data-toggle="modal">購物車<i class="icon-shopping-cart"></i></a></li>
							<li><a class="btn-myShop" href="#sellerPanel" data-toggle="modal">我的商店<i class="icon-home"></i></a></li>
							<li><a class="btn-settingModal" href="#settingModal" data-toggle="modal">設定<i class="icon-wrench"></i></a></li>
							<li><a class="userInfo" href="#"><i class="icon-user"></i><span class="username"></span></a></li>
							<li><a id="logoutBtn" href="#">登出</a></li>
						</ul>
					</div><!--/.nav-collapse -->
				</div>
			</div>
		</div>
		
		<!--Login modal -->
		<div id="loginModal" class="modal hide fade" tabindex="-1" role="dialog" aria-hidden="true">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
				<h3>會員登入</h3>
			</div>
			<div class="modal-body">
				<div class="form-horizontal">
					<div class="control-group">
						<label class="control-label" for="loginEmail">Email</label>
						<div class="controls">
							<input type="text" id="loginEmail" placeholder="Email">
						</div>
					</div>
					<div class="control-group">
						<label class="control-label" for="loginPassword">密碼</label>
						<div class="controls">
							<input type="password" id="loginPassword" placeholder="Password">
						</div>
					</div>
					<div class="control-group">
						<div class="controls">
							<label class="checkbox">
								<input type="checkbox"> 記得我
							</label>
						</div>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button class="btn" data-dismiss="modal" aria-hidden="true">關閉</button>
				<button id="loginBtn" class="btn btn-primary">登入</button>
			</div>
		</div>
		
		<!--Registration modal -->
		<div id="regModal" class="modal hide fade" tabindex="-1" role="dialog" aria-hidden="true">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
				<h3>會員註冊</h3>
			</div>
			<div class="modal-body">
				<div class="form-horizontal">
					<div id="regEmailField" class="control-group">
						<label class="control-label" for="regEmail">帳號/Email</label>
						<div class="controls">
							<input type="text" id="regEmail" placeholder="使用E-mail作為您的帳號">
							<span class="help-inline msg-error"></span>
						</div>
					</div>
					<div id="regUsernameField" class="control-group">
						<label class="control-label" for="regUsername">名稱</label>
						<div class="controls">
							<input type="text" id="regUsername" placeholder="最多填入20個字元">
							<span class="help-inline msg-error"></span>
						</div>
					</div>
					<div id="regPasswordField" class="control-group">
						<label class="control-label" for="regPassword">密碼</label>
						<div class="controls">
							<input type="password" id="regPassword" placeholder="請輸入8到16個字元">
							<span class="help-inline msg-error"></span>
						</div>
					</div>
					<div id="regPasswordConfirmField" class="control-group">
						<label class="control-label" for="regPasswordConfirm">確認密碼</label>
						<div class="controls">
							<input type="password" id="regPasswordConfirm" placeholder="">
							<span class="help-inline msg-error"></span>
						</div>
					</div>
					<div id="regCaptchaField" class="control-group">
						<label class="control-label" for="regCaptcha">驗證碼</label>
						<div class="controls">
							<div><img id="regCaptchaImage"></div>
							<button class="btn btn-small" id="refreshCaptcha"><i class="icon-refresh"></i></button>
							<input class="input-small" type="text" id="regCaptcha" placeholder="">
							<span class="help-inline msg-error"></span>
						</div>
					</div>
					<div id="regAgreeField" class="control-group">
						<div class="controls">
							<label class="checkbox">
								<input id="regAgree" type="checkbox">
								<span class="help-inline">我已經詳細閱讀並同意xxx服務條款</span>
							</label>
						</div>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button class="btn" data-dismiss="modal" aria-hidden="true">關閉</button>
				<button id="registerBtn" data-loading-text="註冊中..." class="btn btn-primary">註冊</button>
			</div>
		</div>
		
		<!--Setting modal -->
		<div id="settingModal" class="modal hide fade container" tabindex="-1" role="dialog" aria-hidden="true">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
				<h3><img src="img/setting.png" style="vertical-align:bottom;width:130px;height:130px;">帳號設定</h3>
			</div>
			<div class="row">
				<div class="span3">
					<ul class="nav nav-list">
						<li class="active"><a href="#">會員設定</a></li>
						<li><a href="#">Privacy</a></li>
					</ul>
				</div>
				<div class="span6 modal-body">
					<div id="accountSetting">
						<div class="accordion">
						<div class="accordion-group">
							<div class="accordion-heading">
								<a class="accordion-toggle" data-toggle="collapse" href="#collapsePhoto">照片</a>
							</div>
							<div id="collapsePhoto" class="accordion-body collapse">
								<div class="accordion-inner">
									<img src="img/setting.png" style="width: 130px; height: 130px;">
									<button class="btn btn-primary">上傳照片</button>
								</div>
							</div>
						</div>
						<div class="accordion-group">
							<div class="accordion-heading">
								<a class="accordion-toggle" data-toggle="collapse" href="#collapseAccount">
									帳號
								</a>
							</div>
							<div id="collapseAccount" class="accordion-body collapse">
								<div class="accordion-inner">
									<div class="form-horizontal">
										<div class="control-group">
											<label class="control-label" for="settingEmail">帳號/Email</label>
											<div class="controls">
												<input type="text" id="settingEmail" placeholder="">
											</div>
										</div>
										<div class="control-group">
											<label class="control-label" for="settingUsername">名稱</label>
											<div class="controls">
												<input type="text" id="settingUsername" placeholder="">
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="accordion-group">
							<div class="accordion-heading">
								<a class="accordion-toggle" data-toggle="collapse" href="#collapsePassword">修改密碼</a>
							</div>
							<div id="collapsePassword" class="accordion-body collapse">
								<div class="accordion-inner">
									<div class="form-horizontal">
										<div class="control-group">
											<label class="control-label" for="settingPassword">舊密碼</label>
											<div class="controls">
												<input type="password" id="settingPassword" placeholder="">
											</div>
										</div>
										<div class="control-group">
											<label class="control-label" for="settingNewPassword">新密碼</label>
											<div class="controls">
												<input type="password" id="settingNewPassword" placeholder="">
											</div>
										</div>
										<div class="control-group">
											<label class="control-label" for="settingNewPassword2">確認新密碼</label>
											<div class="controls">
												<input type="password" id="settingNewPassword2" placeholder="">
											</div>
										</div>
										<div class="control-group">
											<div class="controls">
												<button class="btn-submit btn btn-primary">確認修改</button>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					</div>
				</div>
				<div class="span2">
					這裡放廣告
				</div>
			</div>
		</div>
		
		<!--Seller Panel-->
		<div id="sellerPanel" class="modal hide fade container" tabindex="-1" role="dialog" aria-hidden="true">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
				<h3><img src="img/setting.png" style="vertical-align:bottom;width:130px;height:130px;">SHOP</h3>
			</div>
			<div class="row">
				<div class="span3">
					<ul class="nav nav-list">
						<li class="active"><a href="#myShop" data-toggle="tab">我的商店</a></li>
						<li><a href="#tab2" data-toggle="tab">我的店面</a></li>
					</ul>
				</div>
				<div class="modal-body span8" style="min-height:400px;max-height:800px;">
					<div class="tab-content">
						<div class="tab-pane active" id="myShop">
							<div>
								<ul class="items list">
									<li class="item" style="position:relative;width:100%;margin:0 0 30px 0;">
										<div class="img"><img height="90" width="120" src="img/160x120.png"></div>
										<div class="title" style="position:absolute;top:0px;left:180px;">品名:塑膠椅</div>
										<div class="price" style="position:absolute;top:30px;left:180px;">價錢:100</div>
										<div class="category" style="position:absolute;top:60px;left:180px;">分類:居家用品->椅子</div>
										<div class="attribute" style="position:absolute;top:0px;left:360px;width:30px">
											<span class="label label-info">二手品</span>
											<span class="label label-info">機車可載</span>
										</div>
										<div class="description" style="position:absolute;top:0px;left:450px;">商品描述</div>
									</li>
									<li>
										<button class="btn btn-large btn-block btn-primary" type="button">新增商品</button>
									</li>
								</ul>
							</div>
						</div>
						<div class="tab-pane" id="tab2">
							<p>One fine body…qqqqqqqqqqqqqqqq</p>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- 
		<div class="container-fluid">
			<div class="row-fluid">
				<div style="background-color:#dceaf4;" class="span10">
				aaa
				</div>
				<div style="background-color:#dceaf4;" class="span2">
				bbb
				</div>
			</div>
		</div>
		 -->
		<div class="" id="map_canvas">
		</div> <!-- /container -->
		
		<!--<script src="js/less-1.3.3.min.js"></script>-->
		<script src="http://code.jquery.com/jquery.js"></script>
		<script src="js/bootstrap.js"></script>
		<!-- <script src="js/bootstrap.min.js"></script> -->
		<!--<script src="js/bootstrap-modal.js"></script>
		<script src="js/bootstrap-modalmanager.js"></script>-->
		<script src="js/underscore-min.js"></script>
		<script src="js/backbone-min.js"></script>
		<script src="js/main.js"></script>
		<script type="text/javascript">
		
		function viewport()
		{
			var e = window
			, a = 'inner';
			if ( !( 'innerWidth' in window ) )
			{
				a = 'client';
				e = document.documentElement || document.body;
			}
			return { width : e[ a+'Width' ] , height : e[ a+'Height' ] }
		}
		$(window).resize(function() {
			console.log(viewport())
		});

		var User = Backbone.Model.extend({
			defaults : {
				name : null,
				email: null,
			},
			urlRoot:'accounts/users/'
		});
		
		var loginUser = new User({id:'i'});
		
		var sellerPanelView = Backbone.View.extend({
			el: $("#sellerPanel"),
			events: {
				"show": "showPanel",
				"click #testBtn": "test",
			},
			test:function(){
				this.$el.modal('hide');
			},
			initialize: function() {
				$("#sellerPanel").modal({show:false,});
				
			},
			showPanel: function(){
				console.log('show');
				/*
				var view = this;
				$("#sellerPanel").modal({height:'100px'});
				this.$el.modal({height:'100px'});
				
				view.$el.modal('loading');
				setTimeout(function(){
					view.$el.modal('loading');
				}, 1000);
				*/
			}
		});
		
		var loginModalView = Backbone.View.extend({
			el: $("#loginModal"),
			events: {
				"show": "showModal",
				"click #loginBtn": "login",
			},
			initialize: function() {
				this.$('#loginEmail').val("");
				this.$('#loginPassword').val("");
			},
			showModal: function() {
				this.$('#loginPassword').val("");
			},
			login: function() {
				var thisView = this;
				var navBar = this.options.navBar;
				var email = this.$("#loginEmail").val();
				var password = this.$("#loginPassword").val();
				$.get('accounts/login',{email:email,password:password})
				.done(function(){
					console.log('login done!')
					loginUser.fetch();
					thisView.$el.modal('hide');
				}).fail(function(jqXHR, textStatus, errorThrown){
					alert('帳號或密碼錯誤!');
				});
			},
			render: function() {
				
			}
		});
		
		var regModalView = Backbone.View.extend({
			el: $("#regModal"),
			events: {
				"show": "showModal",
				"click #registerBtn": "register",
				"click #refreshCaptcha": "getCaptcha",
				"change #regEmail": "checkEmail",
				"change #regUsername": "checkUsername",
				"keyup #regPassword": "checkPassword",
				"keyup #regPasswordConfirm": "checkPasswordConfirm",
				"keyup #regCaptcha": "clearCaptcha",
				"click #regAgree": "clearAgree",
			},
			initialize: function() {
				this.field = {
					name: this.$('#regUsernameField'),
					email: this.$('#regEmailField'),
					password: this.$('#regPasswordField'),
					passwordConfirm: this.$('#regPasswordConfirmField'),
					captcha: this.$('#regCaptchaField'),
					agree: this.$('#regAgreeField')
				}
				
				this.input = {
					name: this.$('#regUsername'),
					email: this.$('#regEmail'),
					password: this.$('#regPassword'),
					passwordConfirm: this.$('#regPasswordConfirm'),
					captcha: this.$('#regCaptcha'),
					agree: this.$('#regAgree')
				}
				
				this.$regBtn = this.$('#registerBtn');
			},
			showError: function(fieldName, msg){
				var $field = this.field[fieldName];
				if(!$field){return;}
				$field.addClass('error');
				if(msg){$field.find('.msg-error').text(msg);}
			},
			clearError: function(fieldName){
				var $field = this.field[fieldName];
				$field.removeClass('error');
				$field.find('.msg-error').text('');
			},
			clearAgree: function(){
				this.clearError('agree');
			},
			clearCaptcha: function(){
				this.clearError('captcha');
			},
			checkEmail: function(){
				var view = this;
				var email = this.input.email.val();
				if(email.length == 0){
					this.clearError('email');
					return;
				}
				$.getJSON('accounts/check-email', {email: email})
				.done(function(data){
					if(data.status == 'ERROR'){
						view.showError('email',data.msg);
					}else{
						view.clearError('email');
					}
				});
			},
			checkUsername:function(){
				var view = this;
				var name = this.input.name.val();
				var $nameField = this.$nameField;
				if(name.length == 0){
					this.clearError('name');
					return
				}else if(name.length > 20){
					view.showError('name', '名稱太長');
					return
				}
				$.getJSON('accounts/check-name', {name:name}).done(function(data){
					if(data.status == 'ERROR'){
						view.showError('name', data.msg);
					}else{
						view.clearError('name');
					}
				});
			},
			checkPassword:function(){
				var password = this.input.password.val();
				var length = password.length;
				if(length > 0 && length < 8){
					this.showError('password', '密碼長度太短');
				}else if(length > 16){
					this.showError('password', '密碼長度太長');
				}else{
					this.clearError('password');
				}
			},
			checkPasswordConfirm:function(){
				var password = this.input.password.val();
				var passwordConfirm = this.input.passwordConfirm.val();
				
				if(password != passwordConfirm){
					this.showError('passwordConfirm', '密碼不符');
				}else{
					this.clearError('passwordConfirm');
				}
			},
			showModal: function() {
				this.getCaptcha();
				this.input.name.val("");
				this.input.email.val("");
				this.input.password.val("");
				this.input.passwordConfirm.val("");
				this.input.captcha.val();
				this.input.agree.prop("checked",false);
				this.$('.error').removeClass('error');
				this.$('.msg-error').text('');
			},
			getCaptcha: function(){
				var d = new Date();
				$("#regCaptchaImage").attr("src", "accounts/captcha?"+d.getTime());
				this.input.captcha.val('');
			},
			register: function() {
				var view = this;
				var name = this.input.name.val();
				var email = this.input.email.val();
				var password = this.input.password.val();
				var captcha = this.input.captcha.val();
				var agree = this.input.agree.prop("checked");
				
				if(this.$('.error').length != 0){
					return;
				}else if(email.length == 0){
					this.showError('email', '請輸入帳號');
					return;
				}else if(name.length == 0){
					this.showError('name', '請輸入名稱');
					return;
				}else if(password.length == 0){
					this.showError('password', '請輸入密碼');
					return;
				}else if(captcha.length == 0){
					this.showError('captcha', '請輸入驗證碼');
					return;
				}else if(!agree){
					this.showError('agree');
					return;
				}
				
				var $regBtn = this.$regBtn;
				$regBtn.button('loading');
				
				$.post('accounts/create-user',{name:name,email:email,password:password,captcha:captcha},'json')
				.done(function(data){
					$regBtn.button('reset');
					console.log(data);
					if(data.status == 'OK'){
						view.$el.modal('hide');
						loginUser.set('id','i').fetch();
						return;
					}
					
					for(var fieldName in data){
						if(fieldName == 'captcha'){
							view.getCaptcha();
						}
						view.showError(fieldName, data[fieldName]);
					}
					
				}).fail(function(){
					$regBtn.button('reset');
					alert('註冊失敗!');
				});
			},
			render: function() {
				
			}
		});
		
		var settingView = Backbone.View.extend({
			el:$('#settingModal'),
			events:{
				'click #collapsePassword .btn-submit':'changePassword'
			},
			initialize: function() {
				this.listenTo(loginUser, 'change:name', this.updateUser);
			},
			changePassword: function(){
				var thisView = this;
				var password = this.$('#settingPassword').val();
				var newPassword = this.$('#settingNewPassword').val();
				var newPassword2 = this.$('#settingNewPassword2').val();
				if (newPassword !== newPassword2){
					alert('新密碼不相符!');
					return
				}
				$.post('accounts/password',{password:password,newpassword:newPassword})
				.done(function(data){
					alert('修改完成!')
					thisView.$('#settingPassword').val('');
					thisView.$('#settingNewPassword').val('');
					thisView.$('#settingNewPassword2').val('');
				}).fail(function(a,b){
					console.log(a)
					console.log(b)
					alert('密碼錯誤!');
				});
			},

			updateUser: function(){
				console.log(loginUser)
				var email = loginUser.get('email');
				var name = loginUser.get('name');
				this.$('#settingEmail').val(email);
				this.$('#settingUsername').val(name);
			}
		})
		
		
		var navBarView = Backbone.View.extend({
			el:$('#navBar'),
			events: {
				"click #logoutBtn": "logout",
			},
			initialize: function() {
				this.$userNav = this.$("#userNav");
				this.$guestNav = this.$("#guestNav");
				this.guestMode();
				
				this.listenTo(loginUser, 'change:name', this.changeMode);
				
			},
			changeMode: function(){
				if(loginUser.get('name') == 'guest'){
					this.guestMode();
				}else{
					this.userMode(loginUser);
				}
				console.log('changeMode');
				console.log(loginUser);
			},
			logout: function(){
				$.get('accounts/logout').done(function(data) {
					loginUser.set('id','i');
					loginUser.fetch();
				}).fail(function(){
					alert('登出失敗!');
				});
			},
			guestMode: function(){
				this.$userNav.hide();
				this.$guestNav.show();
			},
			userMode: function(user){
				this.$userNav.show().find('.username').text(user.get('name'));
				this.$guestNav.hide();
			}
		});
		/*
		var testUser2 = new User({id:2});
		testUser2.fetch();
		console.log(testUser2);
		
		var testUser = new User({name:'qq',email:'qq@qq.com',password:'password'});
		testUser.save();
		console.log(testUser);
		
		$.get('accounts/captcha',function(data){
			console.log(data);
		});
		*/
			$(function(){
				function initialize() {
					var initlatlng = new google.maps.LatLng(25.056220142845, 121.54178450802);
					var mapOptions = {
						center: initlatlng,
						zoom: 14,
						mapTypeId: google.maps.MapTypeId.ROADMAP
					};
					var map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
					var noPoi = [{
						featureType: "poi",
						stylers: [{ visibility: "off" }]
					}];
					map.setOptions({styles: noPoi});
				}
				//initialize();
				
				var navBar = new navBarView();
				var loginModal = new loginModalView({navBar:navBar});
				var regModal = new regModalView({navBar:navBar});
				var settingModal = new settingView();
				var sellerPanel = new sellerPanelView();
				
				loginUser.fetch();
				
			});
		</script>
	</body>
</html>